version: 3

vars:
  LOCAL_BIN:
    sh: echo "$(pwd)/bin"
  PATH:
    sh: echo "{{ .LOCAL_BIN }}:{{ env "PATH" }}"

tasks:
  generate:
    deps:
      - task: bin-deps
    cmds:
      - PATH="{{ .PATH }}" oapi-codegen -config ./configs/openapi/error.yaml ./api/common/error.openapi.yaml
      - PATH="{{ .PATH }}" oapi-codegen -config ./configs/openapi/auth.yaml ./api/v1/auth.openapi.yaml
      - PATH="{{ .PATH }}" oapi-codegen -config ./configs/openapi/profile.yaml ./api/v1/profile.openapi.yaml
      - PATH="{{ .PATH }}" oapi-codegen -config ./configs/openapi/user.yaml ./api/v1/user.openapi.yaml
      - go mod tidy
      - go mod vendor
  bin-deps:
    cmds:
      - test -d {{ .LOCAL_BIN }} || mkdir {{ .LOCAL_BIN }}
      - GOBIN={{ .LOCAL_BIN }} go install tool
